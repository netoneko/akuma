[build]
target = "aarch64-unknown-none"

[target.aarch64-unknown-none]
# Runner with user-mode networking
# Force legacy virtio mode (version 1) for better compatibility
runner = """qemu-system-aarch64 \
  -semihosting \
  -machine virt \
  -cpu max \
  -m 128M \
  -L qemu-roms \
  -serial mon:stdio \
  -display gtk \
  -netdev user,id=net0,hostfwd=tcp::2323-:23,hostfwd=tcp::2222-:22,hostfwd=tcp::8080-:8080 \
  -global virtio-mmio.force-legacy=true \
  -device virtio-net-device,netdev=net0,bus=virtio-mmio-bus.0 \
  -drive file=disk.img,if=none,format=raw,id=hd0 \
  -device virtio-blk-device,drive=hd0,bus=virtio-mmio-bus.1 \
  -device virtio-rng-device,bus=virtio-mmio-bus.2 \
  -device ramfb \
  -device loader,file=virt.dtb,addr=0x47f00000,force-raw=on \
  -kernel"""

rustflags = ["-C", "link-arg=-Tlinker.ld"]